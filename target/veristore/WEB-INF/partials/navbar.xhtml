<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:f="jakarta.faces.core">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" aria-label="Primary">
        <div class="container py-3">
            <h:link outcome="/index" styleClass="navbar-brand d-flex align-items-center gap-2 me-4">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <rect width="32" height="32" rx="8" fill="#0d6efd"/>
                    <path d="M16 8L20 12H18V20H14V12H12L16 8Z" fill="white"/>
                    <path d="M10 22H22V24H10V22Z" fill="white"/>
                    <circle cx="16" cy="16" r="1.5" fill="white"/>
                </svg>
                <span class="fw-bold fs-4 text-dark">Veristore</span>
            </h:link>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 gap-lg-3 align-items-lg-center">
                    <li class="nav-item">
                        <h:link outcome="/index" styleClass="nav-link text-dark fw-medium px-2">
                            Shop
                        </h:link>
                    </li>
                    <li class="nav-item">
                        <h:link outcome="/history" styleClass="nav-link text-dark fw-medium px-2">
                            Orders
                        </h:link>
                    </li>
                    <li class="nav-item">
                        <h:link outcome="/redeem" styleClass="nav-link text-dark fw-medium px-2">
                            Redeem
                        </h:link>
                    </li>
                    <li class="nav-item ms-lg-3">
                        <h:panelGroup id="cartToggle" layout="block">
                            <button class="btn btn-primary position-relative px-4 py-2 rounded-pill d-flex align-items-center gap-2"
                                    type="button"
                                    data-bs-toggle="offcanvas"
                                    data-bs-target="#cartDrawerPanel"
                                    aria-controls="cartDrawerPanel"
                                    aria-label="View cart">
                                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                                    <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                </svg>
                                <span class="fw-semibold">Cart</span>
                                <h:panelGroup styleClass="position-absolute top-0 start-100 translate-middle badge rounded-pill #{cartView.itemCount gt 0 ? 'bg-danger' : 'bg-white text-primary border'}"
                                             rendered="#{cartView.itemCount ge 0}"
                                             style="font-size: 0.65rem; padding: 0.25rem 0.45rem; min-width: 1.5rem;">
                                    #{cartView.itemCount}
                                    <span class="visually-hidden">items in cart</span>
                                </h:panelGroup>
                            </button>
                        </h:panelGroup>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <h:panelGroup id="cartDrawer" layout="block">
        <div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawerPanel" aria-labelledby="cartDrawerLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="cartDrawerLabel">Your cart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <h:form id="cartForm" styleClass="d-flex flex-column gap-3">
                    <h:panelGroup rendered="#{cartView.hasNoItems}" layout="block">
                        <p class="text-muted mb-0">Your cart is empty. Add a package to begin checkout.</p>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not cartView.hasNoItems}" layout="block" styleClass="d-flex flex-column gap-3">
                        <ui:repeat value="#{cartView.lines}" var="line">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="fw-semibold mb-1">#{line.name}</h6>
                                            <p class="text-muted small mb-0">SKU #{line.sku} · Qty #{line.qty}</p>
                                        </div>
                                        <span class="fw-semibold">#{line.totalFormatted}</span>
                                    </div>
                                    <p class="small text-muted mb-3">#{line.priceFormatted} per unit · #{cartView.paymentModeLabel(line.paymentMode)}</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        <h:commandButton value="#{cartView.checkoutButtonLabel(line.paymentMode)}"
                                                         action="#{cartView.goToCheckout(line.sku)}"
                                                         styleClass="btn btn-primary btn-sm" />
                                        <h:commandButton value="Remove"
                                                         action="#{cartView.removeLine(line.sku)}"
                                                         styleClass="btn btn-outline-secondary btn-sm">
                                            <f:ajax render=":cartToggle :cartDrawer" />
                                        </h:commandButton>
                                    </div>
                                </div>
                            </div>
                        </ui:repeat>
                        <div class="border-top pt-3">
                            <h6 class="fw-semibold mb-2">Totals</h6>
                            <ui:repeat value="#{cartView.totalsByCurrency.entrySet()}" var="total">
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">#{total.key}</span>
                                    <span class="fw-semibold">#{total.value}</span>
                                </div>
                            </ui:repeat>
                        </div>
                    </h:panelGroup>
                </h:form>
            </div>
        </div>
    </h:panelGroup>
</ui:composition>
