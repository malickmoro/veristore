<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                template="/WEB-INF/template.xhtml">
    <ui:define name="title">Order history</ui:define>
    <ui:define name="content">
        <section class="mb-5" aria-labelledby="historyHeading">
            <div class="row g-5 align-items-center">
                <div class="col-12 col-lg-7">
                    <h1 id="historyHeading" class="display-6 fw-bold mb-3">Look up your PIN orders</h1>
                    <p class="lead text-muted">Search by email address or phone number to view previously delivered PINs. Only masked codes are shown for security.</p>
                </div>
                <div class="col-12 col-lg-5">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h2 class="h5 mb-3">Tips</h2>
                            <ul class="list-unstyled text-muted small mb-0">
                                <li class="mb-2">You can search with either email or phone; both is even better.</li>
                                <li class="mb-2">Recent orders appear first. Pending invoices only show after redemption.</li>
                                <li class="mb-0">Need to redeem an invoice? Go to the redeem page with your invoice number.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section aria-labelledby="historyFormHeading">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h2 id="historyFormHeading" class="h4 mb-4">Search orders</h2>
                    <h:form id="historyForm" styleClass="row g-3 align-items-end">
                        <div class="col-12 col-md-5">
                            <h:outputLabel for="email" value="Email" styleClass="form-label" />
                            <h:inputText id="email" value="#{historyView.email}" styleClass="form-control form-control-lg" pt:type="email" />
                        </div>
                        <div class="col-12 col-md-5">
                            <h:outputLabel for="phone" value="Phone" styleClass="form-label" />
                            <h:inputText id="phone" value="#{historyView.phone}" styleClass="form-control form-control-lg" />
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                            <h:commandButton value="Search" styleClass="btn btn-primary btn-lg" action="#{historyView.search}" />
                        </div>
                    </h:form>
                </div>
            </div>

            <h:panelGroup rendered="#{historyView.searched}" layout="block">
                <h:panelGroup rendered="#{not empty historyView.results}" layout="block">
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">Order</th>
                                <th scope="col">Service</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Total paid</th>
                                <th scope="col">Masked PINs</th>
                                <th scope="col">Date</th>
                            </tr>
                            </thead>
                            <tbody>
                            <ui:repeat value="#{historyView.results}" var="order">
                                <tr>
                                    <th scope="row">#{order.orderId}</th>
                                    <td>#{order.serviceDefinition.name}</td>
                                    <td>#{order.quantity}</td>
                                    <td>#{order.totalAmount}</td>
                                    <td>
                                        <ul class="list-unstyled mb-0">
                                            <ui:repeat value="#{order.maskedPins}" var="pin">
                                                <li><span class="badge bg-secondary">#{pin}</span></li>
                                            </ui:repeat>
                                        </ul>
                                    </td>
                                    <td>#{order.createdAt}</td>
                                </tr>
                            </ui:repeat>
                            </tbody>
                        </table>
                    </div>
                </h:panelGroup>
                <h:panelGroup rendered="#{empty historyView.results}" layout="block" styleClass="text-center py-4 text-muted">
                    <p class="mb-0">No matching orders yet. Try another email or phone number, or complete a new purchase.</p>
                </h:panelGroup>
            </h:panelGroup>
        </section>
    </ui:define>
</ui:composition>
